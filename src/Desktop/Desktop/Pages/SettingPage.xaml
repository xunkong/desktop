<Page x:Class="Xunkong.Desktop.Pages.SettingPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:cc="using:CommunityToolkit.WinUI.UI.Controls"
      xmlns:controls="using:Xunkong.Desktop.Controls"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:local="using:Xunkong.Desktop.Pages"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:models="using:Xunkong.Desktop.Models"
      xmlns:ui="using:CommunityToolkit.WinUI.UI"
      xmlns:viewmodels="using:Xunkong.Desktop.ViewModels"
      xmlns:xcx="using:Xunkong.Core.XunkongApi"
      d:DataContext="{x:Bind viewmodels:SettingViewModel}"
      x:DefaultBindMode="OneWay"
      Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
      mc:Ignorable="d">

    <Page.Resources>
        <Style TargetType="controls:SettingCard">
            <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}" />
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}" />
        </Style>
    </Page.Resources>



    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="60" />
            <RowDefinition />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition MaxWidth="1200" />
            <ColumnDefinition />
            <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>


        <Grid Grid.ColumnSpan="2"
              Padding="48,0,48,0"
              Background="{ThemeResource CustomControlBackgroundAcrylicBrush}"
              CornerRadius="4,0,0,4">
            <TextBlock HorizontalAlignment="Left"
                       VerticalAlignment="Center"
                       Style="{ThemeResource SubtitleTextBlockStyle}"
                       Text="设置" />
        </Grid>

        <ScrollViewer Grid.Row="1"
                      Grid.ColumnSpan="2"
                      Padding="48,0,48,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition MaxWidth="1200" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Margin="0,24,0,24" Spacing="8">

                    <Grid Height="120" ColumnSpacing="16">
                        <Grid.RowDefinitions>
                            <RowDefinition />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition />
                        </Grid.ColumnDefinitions>
                        <Border Grid.RowSpan="2"
                                Height="120"
                                HorizontalAlignment="Left"
                                CornerRadius="8">
                            <Image Source="ms-appx:///Assets/Logos/LogoWithBackground.png" />
                            <ToolTipService.ToolTip>
                                <ToolTip MaxWidth="1000"
                                         MaxHeight="1000"
                                         Background="Transparent"
                                         Placement="Right">
                                    <Image Width="600" Source="ms-appx:///Assets/Logos/LogoWithBackground.png" />
                                </ToolTip>
                            </ToolTipService.ToolTip>
                        </Border>
                        <TextBlock Grid.Column="1"
                                   Margin="0,4,0,0"
                                   TextWrapping="Wrap">
                            <Run Text="用爱发电的「原神」辅助工具，觉得好用就给个 Star 吧。（如果有赞助就更好了）" />
                            <LineBreak />
                            <LineBreak />
                            <Run FontSize="12"
                                 Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                 Text="怎么是派蒙？  因为荧在寻空。" />
                        </TextBlock>
                        <StackPanel Grid.Row="1"
                                    Grid.Column="1"
                                    Orientation="Horizontal"
                                    Spacing="8">
                            <TextBlock Margin="0,0,4,0"
                                       VerticalAlignment="Center"
                                       Text="相关链接" />
                            <HyperlinkButton Content="GitHub 存储库" NavigateUri="https://github.com/Scighost/Xunkong" />
                            <HyperlinkButton Content="镜像下载地址"
                                             NavigateUri="https://scighost.coding.net/public-artifacts/xunkong/releases/packages"
                                             ToolTipService.ToolTip="每天有 50GB 流量限制" />
                            <HyperlinkButton Command="{x:Bind vm.CopyDevelopersMailCommand}" Content="联系开发者" />
                            <HyperlinkButton Content="赞助开发者" NavigateUri="https://xunkong-1306705684.file.myqcloud.com/download/donate.png" />
                        </StackPanel>
                    </Grid>
                    <!--  版本与外观  -->
                    <TextBlock />
                    <TextBlock Style="{ThemeResource SubtitleTextBlockStyle}" Text="版本与外观" />
                    <!--  检查更新  -->
                    <Expander HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                        <Expander.Header>
                            <Grid>
                                <StackPanel Padding="4,16,0,16" Orientation="Horizontal">
                                    <SymbolIcon Symbol="Sync" />
                                    <TextBlock Margin="20,0,0,0">
                                        <Run Text="{x:Bind vm.AppName}" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="{x:Bind vm.AppVersion}" />
                                    </TextBlock>
                                </StackPanel>
                                <Button HorizontalAlignment="Right"
                                        Command="{x:Bind vm.CheckUpdateCommand}"
                                        Content="检查更新" />
                            </Grid>
                        </Expander.Header>
                        <Expander.Content>
                            <StackPanel>
                                <Grid Margin="44,0,44,0">
                                    <StackPanel HorizontalAlignment="Left"
                                                Orientation="Horizontal"
                                                Spacing="16">
                                        <TextBlock>
                                            <Run Text="更新通道" />
                                            <LineBreak />
                                            <Run FontSize="12"
                                                 Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                 Text="正式版享受长期不更，预览版体验更多 Bug 。" />
                                        </TextBlock>
                                    </StackPanel>
                                    <ComboBox HorizontalAlignment="Right"
                                              VerticalAlignment="Center"
                                              ItemsSource="{x:Bind vm.ChannelTypeList}"
                                              SelectedItem="{x:Bind vm.SelectedChannel, Mode=TwoWay}">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate x:DataType="xcx:ChannelType">
                                                <TextBlock Text="{x:Bind Converter={StaticResource EnumToDescriptionOrStringConverter}}" />
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </Grid>
                            </StackPanel>
                        </Expander.Content>
                    </Expander>


                    <!--  应用主题  -->
                    <controls:SettingCard>
                        <controls:SettingCard.Icon>
                            <Path Data="M511.728 0c-144.592 4-265.024 54.128-361.312 150.4C54.144 246.704 4 367.152 0 511.744c0 45.296 7.328 88.272 21.984 128.928 14.656 40.64 35.824 76.624 63.472 107.936 27.648 31.312 59.296 55.312 94.944 71.968 35.648 16.64 73.632 24.976 113.936 24.976 40.32 0 79.968-8.992 118.944-26.976 38.976-18 76.128-44.64 111.44-79.968l2-1.984c65.296-81.296 133.6-121.6 204.896-120.944 23.312 0 45.632 3.168 66.96 9.504 21.328 6.32 41.312 13.152 59.968 20.48a435.68 435.68 0 0 0 42.48 14.992c13.664 4 26.48 6 38.48 6 39.968-3.328 64.464-23.328 73.456-59.968 8.992-36.64 12.496-68.304 10.496-94.944-4-144.592-54.144-265.04-150.416-361.312-96.288-96.288-216.72-146.432-361.312-150.416z m427.776 602.672c-6.672 0-15.168-1.664-25.488-4.992a607.584 607.584 0 0 1-33.488-12c-19.984-8-42.48-15.488-67.456-22.48-24.992-7.008-52.144-10.832-81.456-11.504-91.296-0.656-175.904 46.976-253.872 142.928-28.64 28.64-58.464 50.304-89.44 64.96-30.992 14.656-62.48 22-94.464 22-30.64 0-59.632-6.496-86.944-19.504-27.328-12.992-51.984-31.968-73.968-56.96s-38.976-54.144-50.976-87.456c-12-33.312-17.984-68.64-17.984-105.936 3.328-126.608 47.136-232.048 131.424-316.336 84.288-84.288 189.744-128.096 316.336-131.44 126.608 3.344 232.048 47.152 316.32 131.44 84.304 84.288 128.112 189.728 131.44 316.32 0 16-1.168 34.656-3.488 55.984-2.336 21.312-7.84 32.976-16.496 34.976z m-202.88-182.896c0 17.984 6.144 32.976 18.48 44.96 12.32 12 27.488 18 45.472 18s32.976-6 44.976-17.984c12-12 17.984-26.992 17.984-44.976 0-18-5.984-32.992-17.984-44.976-12-12-26.992-18-44.976-18-17.984 0-33.152 6-45.472 18s-18.496 26.976-18.496 44.96z m-343.84-202.896c0.672 18.656 7.008 33.984 18.992 45.968 12 12 26.992 18 44.976 18 18 0 32.992-6 44.976-18 12-12 18-27.152 18-45.472s-6-33.488-18-45.472c-12-12-26.976-18-44.96-18-18 0-32.992 6-44.992 18s-18.32 26.976-18.976 44.96z m215.888 26.976c0 18 6.176 32.992 18.496 44.976 12.32 12 27.488 18 45.472 18 18 0 32.992-6 44.976-18 12-12 18-26.976 18-44.96 0-18-6-32.992-18-44.992s-26.976-17.984-44.96-17.984c-18 0-33.168 6-45.488 17.984-12.32 12-18.496 26.992-18.496 44.976zM226.88 355.808c0.672 17.984 6.992 32.976 18.992 44.96 12 12 27.152 18 45.472 18s33.488-6 45.472-17.984c12-12 18-26.992 18-44.976 0-18-6-32.992-18-44.976-12-12-27.152-18-45.472-18s-33.472 6-45.472 18-18.32 26.976-18.992 44.96z m-44.96 246.864c0.64 27.312 10.144 49.968 28.48 67.968 18.32 17.984 40.96 26.976 67.952 26.976 26.992 0 49.472-8.992 67.472-26.976 17.984-18 26.976-40.64 26.976-67.968 0-27.312-8.992-49.968-26.976-67.968-18-17.984-40.48-26.976-67.472-26.976-26.976 0-49.632 8.992-67.968 26.976-18.32 18-27.808 40.64-28.48 67.968z"
                                  Fill="{ThemeResource TextFillColorPrimaryBrush}"
                                  Stretch="Uniform" />
                        </controls:SettingCard.Icon>
                        <controls:SettingCard.Content>
                            <TextBlock VerticalAlignment="Center">
                                <Run Text="应用主题" />
                                <LineBreak />
                                <Run FontSize="12"
                                     Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                     Text="白天还是夜晚？" />
                            </TextBlock>
                        </controls:SettingCard.Content>
                        <controls:SettingCard.Selector>
                            <ComboBox SelectedIndex="{x:Bind vm.SelectedThemeIndex, Mode=TwoWay}">
                                <ComboBoxItem Content="跟随系统" />
                                <ComboBoxItem Content="浅色模式" />
                                <ComboBoxItem Content="深色模式" />
                            </ComboBox>
                        </controls:SettingCard.Selector>
                    </controls:SettingCard>

                    <!--  不显示背景图  -->
                    <controls:SettingCard>
                        <controls:SettingCard.Icon>
                            <Path Data="M128.299 128C92.788 128 64 156.788 64 192.299v639.4C64 867.212 92.788 896 128.299 896H895.7c35.512 0 64.3-28.788 64.3-64.299V192.299C960 156.788 931.212 128 895.701 128H128.299zM128 588.313l178.162-178.162c24.795-24.795 64.996-24.795 89.792 0L817.803 832H128V588.313z m768 231.375L666.385 590.073l64.718-64.718c25.153-25.152 65.933-25.152 91.085 0L896 599.167v220.521zM694.65 471.299l-73.519 73.519L432.653 356.34c-45.064-45.064-118.127-45.064-163.19 0L128 497.803V192h768v316.657l-37.358-37.358c-45.286-45.285-118.707-45.285-163.992 0z"
                                  Fill="{ThemeResource TextFillColorPrimaryBrush}"
                                  Stretch="Uniform" />
                        </controls:SettingCard.Icon>
                        <controls:SettingCard.Content>
                            <TextBlock Grid.Column="1" VerticalAlignment="Center">
                                <Run Text="不显示每日一图" />
                                <LineBreak />
                                <Run FontSize="12"
                                     Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                     Text="虽然无法设计出美观的界面，但是挑选好看的图片还是没问题" />
                            </TextBlock>
                        </controls:SettingCard.Content>
                        <controls:SettingCard.Selector>
                            <ToggleSwitch IsOn="{x:Bind vm.DisableBackgroundWallpaper, Mode=TwoWay}" Style="{ThemeResource RightAlignToggleSwitchStyle}" />
                        </controls:SettingCard.Selector>
                    </controls:SettingCard>

                    <!--  功能  -->
                    <TextBlock />
                    <TextBlock Style="{ThemeResource SubtitleTextBlockStyle}" Text="功能" />

                    <!--  启动游戏  -->
                    <Expander Name="_Expander_StartGame"
                              HorizontalAlignment="Stretch"
                              HorizontalContentAlignment="Stretch"
                              Expanding="_Expander_StartGame_Expanding">
                        <Expander.Header>
                            <Grid>
                                <StackPanel Padding="4,16,0,16" Orientation="Horizontal">
                                    <Image Width="20" Source="ms-appx:///Assets/Logos/StoreLogo.png" />
                                    <TextBlock Margin="20,0,0,0">
                                        <Run Text="启动游戏" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="也可以在开始菜单的寻空图标上点击右键快速启动" />
                                    </TextBlock>
                                </StackPanel>
                                <Button HorizontalAlignment="Right"
                                        Command="{x:Bind vm.StartGameCommand, Mode=OneTime}"
                                        Content="启动游戏" />
                            </Grid>
                        </Expander.Header>
                        <Expander.Content>
                            <StackPanel Margin="0,-16,44,0">
                                <Grid Padding="44,12,0,12">
                                    <TextBlock TextWrapping="Wrap">
                                        <Run Text="YuanShen.exe 或 GenshinImpact.exe 文件路径" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="{x:Bind vm.GameExePath}" />
                                    </TextBlock>
                                    <Button HorizontalAlignment="Right"
                                            Command="{x:Bind vm.ChangeGameExePathCommand, Mode=OneTime}"
                                            Content="选择文件" />
                                </Grid>
                                <Grid Padding="44,12,0,12">
                                    <TextBlock>
                                        <Run Text="解锁帧数上限" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource SystemFillColorCautionBrush}"
                                             Text="此功能会修改游戏内存，有一定的风险，设定值超过60才会启用" />
                                    </TextBlock>
                                    <NumberBox MinWidth="80"
                                               HorizontalAlignment="Right"
                                               Minimum="60"
                                               SmallChange="10"
                                               SpinButtonPlacementMode="Compact"
                                               Value="{x:Bind vm.UnlockedFPS, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                </Grid>
                                <Grid Padding="44,12,0,12">
                                    <TextBlock>
                                        <Run Text="使用无边框窗口" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="这个就不用介绍了吧" />
                                    </TextBlock>
                                    <ToggleSwitch HorizontalAlignment="Right"
                                                  IsOn="{x:Bind vm.UsePopupWindow, Mode=TwoWay}"
                                                  Style="{ThemeResource RightAlignToggleSwitchStyle}" />
                                </Grid>
                                <MenuFlyoutSeparator />
                                <!--  多账号管理  -->
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition />
                                    </Grid.RowDefinitions>
                                    <CommandBar DefaultLabelPosition="Right">
                                        <CommandBar.Content>
                                            <TextBlock Margin="40,8,0,0">
                                                <Run FontWeight="Bold" Text="多账号管理" />
                                                <LineBreak />
                                                <Run FontSize="12"
                                                     Foreground="{ThemeResource SystemFillColorCautionBrush}"
                                                     Text="通过读写注册表切换已登录的账号，有一定的风险" />
                                            </TextBlock>
                                        </CommandBar.Content>
                                        <AppBarButton Icon="Add" Label="添加">
                                            <AppBarButton.Flyout>
                                                <MenuFlyout Placement="Bottom">
                                                    <MenuFlyoutItem Command="{x:Bind vm.AddGenshinUserAccountCommand, Mode=OneTime}"
                                                                    CommandParameter="{StaticResource False}"
                                                                    Text="国服" />
                                                    <MenuFlyoutItem Command="{x:Bind vm.AddGenshinUserAccountCommand, Mode=OneTime}"
                                                                    CommandParameter="{StaticResource True}"
                                                                    Text="国际服" />
                                                </MenuFlyout>
                                            </AppBarButton.Flyout>
                                        </AppBarButton>
                                        <AppBarButton Command="{x:Bind vm.DeleteSelectedGenshinUserAccountCommand, Mode=OneTime}"
                                                      Icon="Delete"
                                                      Label="删除" />
                                    </CommandBar>
                                    <ListView Grid.Row="1"
                                              Padding="28,0,0,0"
                                              ItemsSource="{x:Bind vm.UserAccounts}"
                                              SelectedItem="{x:Bind vm.SelectedUserAccount, Mode=TwoWay}"
                                              SelectionMode="Single">
                                        <ListView.ItemTemplate>
                                            <DataTemplate x:DataType="models:GenshinUserAccount">
                                                <StackPanel Margin="0,0,16,0"
                                                            Orientation="Horizontal"
                                                            Spacing="16">
                                                    <TextBlock MinWidth="100"
                                                               VerticalAlignment="Center"
                                                               Text="{x:Bind UserName}" />
                                                    <cc:SwitchPresenter Width="60"
                                                                        VerticalAlignment="Center"
                                                                        Value="{x:Bind IsOversea}">
                                                        <cc:Case Value="{StaticResource True}">
                                                            <TextBlock Text="国际服" />
                                                        </cc:Case>
                                                        <cc:Case Value="{StaticResource False}">
                                                            <TextBlock Text="国服" />
                                                        </cc:Case>
                                                    </cc:SwitchPresenter>
                                                    <TextBlock Width="160"
                                                               VerticalAlignment="Center"
                                                               Text="{x:Bind CreateTime, Converter={StaticResource DateTimeOffsetToDateTimeStringConverter}}" />
                                                    <TextBlock Width="160"
                                                               VerticalAlignment="Center"
                                                               Text="{x:Bind LastAccessTime, Converter={StaticResource DateTimeOffsetToDateTimeStringConverter}}" />
                                                </StackPanel>
                                            </DataTemplate>
                                        </ListView.ItemTemplate>
                                    </ListView>
                                </Grid>
                            </StackPanel>
                        </Expander.Content>
                    </Expander>

                    <!--  网页小工具  -->
                    <Expander Name="_Expander_WebTool"
                              HorizontalAlignment="Stretch"
                              HorizontalContentAlignment="Stretch"
                              Collapsed="_Expander_WebTool_Collapsed"
                              Expanding="_Expander_WebTool_Expanding">
                        <Expander.Header>
                            <StackPanel Padding="4,16,0,16" Orientation="Horizontal">
                                <SymbolIcon Symbol="Globe" />
                                <TextBlock Margin="20,0,0,0">
                                    <Run Text="网页小工具" />
                                    <LineBreak />
                                    <Run FontSize="12"
                                         Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                         Text="在左侧导航栏中添加网页小工具" />
                                </TextBlock>
                            </StackPanel>
                        </Expander.Header>
                        <Expander.Content>
                            <Grid RowSpacing="12">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition />
                                </Grid.RowDefinitions>
                                <CommandBar DefaultLabelPosition="Right">
                                    <CommandBar.Content>
                                        <TextBlock Margin="12,14,0,0"
                                                   FontWeight="Bold"
                                                   Text="已添加的网页小工具" />
                                    </CommandBar.Content>
                                    <AppBarButton Command="{x:Bind vm.AddWebToolItemCommand, Mode=OneTime}"
                                                  Icon="Add"
                                                  Label="添加" />
                                    <AppBarButton Command="{x:Bind vm.DeleteSelectedWebToolItemCommand, Mode=OneTime}"
                                                  Icon="Delete"
                                                  Label="删除" />
                                    <AppBarButton Command="{x:Bind vm.SaveWebToolItemCommand, Mode=OneTime}"
                                                  Icon="Save"
                                                  Label="保存" />
                                </CommandBar>
                                <!--  网页小工具  -->
                                <ListView Grid.Row="1"
                                          AllowDrop="True"
                                          CanDragItems="True"
                                          CanReorderItems="True"
                                          ItemsSource="{Binding WebToolItemList, Mode=TwoWay}"
                                          SelectedItem="{x:Bind vm.SelectedWebToolItem, Mode=TwoWay}"
                                          SelectionMode="Single">
                                    <ListView.ItemTemplate>
                                        <DataTemplate x:DataType="models:WebToolItem">
                                            <Grid Margin="0,0,16,0"
                                                  HorizontalAlignment="Stretch"
                                                  ColumnSpacing="16">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="40" />
                                                    <ColumnDefinition Width="*"
                                                                      MinWidth="80"
                                                                      MaxWidth="160" />
                                                    <ColumnDefinition Width="4*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>
                                                <cc:ImageEx Grid.Column="0"
                                                            Width="24"
                                                            Source="{x:Bind Icon}"
                                                            Stretch="Uniform" />
                                                <TextBlock Grid.Column="1"
                                                           VerticalAlignment="Center"
                                                           Text="{x:Bind Title}" />
                                                <TextBlock Grid.Column="2"
                                                           VerticalAlignment="Center"
                                                           Text="{x:Bind Url}" />
                                                <TextBlock Grid.Column="3"
                                                           VerticalAlignment="Center"
                                                           FontFamily="{ThemeResource SymbolThemeFontFamily}"
                                                           Text="&#xE700;" />
                                            </Grid>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </Grid>
                        </Expander.Content>
                    </Expander>

                    <!--  后台任务  -->
                    <Expander HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                        <Expander.Header>
                            <Grid>
                                <StackPanel Padding="4,16,0,16" Orientation="Horizontal">
                                    <SymbolIcon Symbol="Clock" />
                                    <TextBlock Margin="20,0,0,0">
                                        <Run Text="定时刷新磁贴" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="每16分钟刷新一次实时便笺磁贴（Win10 特供）" />
                                    </TextBlock>
                                </StackPanel>
                                <ToggleSwitch HorizontalAlignment="Right"
                                              IsOn="{x:Bind vm.IsRegisterDailyNoteTask, Mode=TwoWay}"
                                              Style="{ThemeResource RightAlignToggleSwitchStyle}" />
                            </Grid>
                        </Expander.Header>
                        <Expander.Content>
                            <StackPanel Margin="0,-16,44,-16">
                                <Grid Padding="44,12,0,12">

                                    <TextBlock>
                                        <Run Text="提醒通知" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="原粹树脂或洞天宝钱超过阈值时，使用系统通知提醒您（Win11 也能用）" />
                                    </TextBlock>
                                    <ToggleSwitch HorizontalAlignment="Right"
                                                  IsOn="{x:Bind vm.EnableDailyNoteNotification, Mode=TwoWay}"
                                                  OffContent="已停止"
                                                  OnContent="已启用"
                                                  Style="{ThemeResource RightAlignToggleSwitchStyle}" />
                                </Grid>
                                <Grid Padding="44,12,0,12">
                                    <TextBlock>
                                        <Run Text="关闭日志功能" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="没有日志会丢失错误信息，不建议关闭后台任务的日志功能" />
                                    </TextBlock>
                                    <ToggleSwitch HorizontalAlignment="Right"
                                                  IsOn="{x:Bind vm.DisableBackgroundTaskOutputLog, Mode=TwoWay}"
                                                  OffContent="未关闭"
                                                  OnContent="已关闭"
                                                  Style="{ThemeResource RightAlignToggleSwitchStyle}" />
                                </Grid>
                                <MenuFlyoutSeparator />
                                <Grid Padding="44,12,0,12">

                                    <TextBlock>
                                        <Run Text="原粹树脂提醒阈值" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="原粹树脂达到此值，且上一次刷新时未达到，发送系统通知" />
                                    </TextBlock>
                                    <NumberBox Width="120"
                                               HorizontalAlignment="Right"
                                               VerticalAlignment="Center"
                                               SmallChange="10"
                                               SpinButtonPlacementMode="Compact"
                                               Value="{x:Bind vm.DailyNoteNotification_ResinThreshold, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                </Grid>
                                <Grid Padding="44,12,0,12">
                                    <TextBlock>
                                        <Run Text="洞天宝钱提醒阈值" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="通天宝钱使用相对阈值" />
                                    </TextBlock>
                                    <NumberBox Name="_NumberBox_HomeCoinThreshold"
                                               Width="120"
                                               HorizontalAlignment="Right"
                                               VerticalAlignment="Center"
                                               SmallChange="0.05"
                                               SpinButtonPlacementMode="Compact"
                                               Value="{x:Bind vm.DailyNoteNotification_HomeCoinThreshold, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                </Grid>
                            </StackPanel>
                        </Expander.Content>
                    </Expander>

                    <!--  米游社签到  -->
                    <Expander HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                        <Expander.Header>
                            <Grid>
                                <StackPanel Padding="4,16,0,16" Orientation="Horizontal">
                                    <Path Width="20"
                                          Data="M901.784183 130.096944l-71.520459 0 0-91.948962c0-21.034552-17.113446-38.147998-38.147998-38.147998l-2.548388 0c-21.031241 0-38.141375 17.11179-38.141375 38.147998l0 91.948962-475.285176 0 0-91.948962c0-21.034552-17.11179-38.147998-38.147998-38.147998l-2.548388 0c-21.034552 0-38.147998 17.11179-38.147998 38.147998l0 91.948962-75.087209 0c-66.715116 0-120.991315 54.276199-120.991315 120.991315L1.217878 902.998766c0 66.720084 54.276199 121.001251 120.991315 121.001251l779.573334 0c66.720084 0 120.999595-54.281167 120.999595-121.001251l0-651.908851C1022.780466 184.374799 968.499299 130.096944 901.784183 130.096944zM946.487782 944.986733l-867.617748 0L78.870034 404.68371l867.617748 0L946.487782 944.986733zM946.487782 324.319235l-867.617748 0 0-117.927951 867.617748 0L946.487782 324.319235zM408.749706 873.666635c6.794046 6.794046 15.696018 10.188585 24.597991 10.188585 6.029033 0 12.041507-1.596261 17.414814-4.710958 3.086547-1.602885 5.98598-3.690941 8.575765-6.280726L811.395053 520.810071c13.584781-13.586437 13.584781-35.612857 0-49.197637-13.586437-13.584781-35.612857-13.584781-49.199293 0L433.644098 800.165752 267.310017 633.830015c-13.586437-13.584781-35.611201-13.584781-49.197637 0-13.584781 13.586437-13.584781 35.611201 0 49.197637L408.749706 873.666635z"
                                          Fill="{ThemeResource TextFillColorPrimaryBrush}"
                                          Stretch="Uniform" />
                                    <TextBlock Margin="20,0,0,0">
                                        <Run Text="米游社签到" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="可能不是很好用" />
                                    </TextBlock>
                                </StackPanel>
                                <ToggleSwitch HorizontalAlignment="Right"
                                              IsOn="{x:Bind vm.IsRegisterHoyolabCheckInTask, Mode=TwoWay}"
                                              Style="{ThemeResource RightAlignToggleSwitchStyle}" />
                            </Grid>
                        </Expander.Header>
                        <Expander.Content>
                            <StackPanel Margin="0,-16,44,-16">
                                <Grid Padding="44,12,0,12">
                                    <TextBlock TextWrapping="Wrap">
                                        <Run Text="间隔时间" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="框架限制无法使用一个准确的时间点运行任务，也没有超出设置时间立即运行的功能" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="所以使用一天之内多次尝试的方法避免错过签到" />
                                    </TextBlock>
                                    <TimePicker Name="_TimePicker"
                                                HorizontalAlignment="Right"
                                                ClockIdentifier="24HourClock"
                                                MinuteIncrement="15"
                                                SelectedTime="{x:Bind vm.HoyolabCheckinTimeSpan, Mode=TwoWay}" />
                                </Grid>
                                <Grid Padding="44,12,0,12">
                                    <TextBlock>
                                        <Run Text="签到成功通知" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="已签到后的再次尝试不会发送通知" />
                                    </TextBlock>
                                    <ToggleSwitch HorizontalAlignment="Right"
                                                  IsOn="{x:Bind vm.DailyCheckInSuccessNotification, Mode=TwoWay}"
                                                  Style="{ThemeResource RightAlignToggleSwitchStyle}" />
                                </Grid>
                                <Grid Padding="44,12,0,12">
                                    <TextBlock>
                                        <Run Text="签到失败通知" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="仅账号和网络相关的错误会发送通知" />
                                    </TextBlock>
                                    <ToggleSwitch HorizontalAlignment="Right"
                                                  IsOn="{x:Bind vm.DailyCheckInErrorNotification, Mode=TwoWay}"
                                                  Style="{ThemeResource RightAlignToggleSwitchStyle}" />
                                </Grid>
                                <Grid Padding="44,12,0,12">
                                    <TextBlock>
                                        <Run Text="立即签到" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="不等待至下次任务执行，立即签到" />
                                    </TextBlock>
                                    <Button HorizontalAlignment="Right"
                                            Command="{x:Bind vm.CheckInNowCommand, Mode=OneTime}"
                                            Content="立即签到" />
                                </Grid>
                            </StackPanel>
                        </Expander.Content>
                    </Expander>

                    <!--  数据库操作  -->
                    <Expander HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                        <Expander.Header>
                            <Grid>
                                <StackPanel Padding="4,16,0,16" Orientation="Horizontal">
                                    <Path Width="20"
                                          Data="M925.0304 82.3808c-25.4464-16.6912-61.0816-31.488-105.9328-43.9296-89.1904-24.7808-207.36-38.4-332.6976-38.4s-243.5072 13.6704-332.6976 38.4c-44.9024 12.4416-80.5376 27.2384-105.9328 43.9296C16.0768 103.2192 0 127.1296 0 153.6v614.4c0 26.4704 16.0768 50.432 47.7696 71.2192 25.4464 16.6912 61.0816 31.488 105.9328 43.9296 89.1904 24.7808 207.36 38.4 332.6976 38.4s243.5072-13.6704 332.6976-38.4512c44.9024-12.4416 80.5376-27.2384 105.9328-43.9296 31.6928-20.7872 47.7696-44.7488 47.7696-71.2192v-614.4c0-26.4704-16.0768-50.432-47.7696-71.2192zM167.424 87.7568C252.3136 64.2048 365.568 51.2 486.4 51.2s234.1376 13.0048 318.976 36.5568C897.28 113.3056 921.6 141.9776 921.6 153.6s-24.2688 40.2944-116.224 65.8432C720.4864 242.9952 607.232 256 486.4 256s-234.1376-13.0048-318.976-36.5568C75.52 193.8944 51.2 165.2224 51.2 153.6s24.2688-40.2944 116.224-65.8432z m637.952 746.0864c-84.8896 23.552-198.144 36.5568-318.976 36.5568s-234.1376-13.0048-318.976-36.5568C75.52 808.2944 51.2 779.6224 51.2 768v-131.3792c25.1904 15.8208 59.5968 29.8496 102.5024 41.7792 89.1904 24.7808 207.36 38.4 332.6976 38.4s243.5072-13.6704 332.6976-38.4512c42.9056-11.9296 77.3632-25.9584 102.5024-41.7792v131.3792c0 11.6224-24.2688 40.2944-116.224 65.8432z m0-204.8c-84.8896 23.552-198.144 36.5568-318.976 36.5568s-234.1376-13.0048-318.976-36.5568C75.52 603.4944 51.2 574.8224 51.2 563.2V431.8208c25.1904 15.8208 59.5968 29.8496 102.5024 41.7792 89.1904 24.7808 207.36 38.4 332.6976 38.4s243.5072-13.6704 332.6976-38.4c42.9056-11.9296 77.3632-25.9584 102.5024-41.7792V563.2c0 11.6224-24.2688 40.2944-116.224 65.8432z m0-204.8C720.4864 447.7952 607.232 460.8 486.4 460.8s-234.1376-13.0048-318.976-36.5568C75.52 398.6944 51.2 370.0224 51.2 358.4V227.0208c25.1904 15.8208 59.5968 29.8496 102.5024 41.7792C242.8928 293.5808 361.0624 307.2 486.4 307.2s243.5072-13.6704 332.6976-38.4c42.9056-11.9296 77.3632-25.9584 102.5024-41.7792V358.4c0 11.6224-24.2688 40.2944-116.224 65.8432z"
                                          Fill="{ThemeResource TextFillColorPrimaryBrush}"
                                          Stretch="Uniform" />
                                    <TextBlock Margin="20,0,0,0">
                                        <Run Text="数据库操作" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="如果觉得数据库文件很大了，可以尝试清理一下" />
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Expander.Header>
                        <Expander.Content>
                            <StackPanel Margin="0,-16,44,-16">
                                <Grid Padding="44,12,0,12">
                                    <TextBlock>
                                        <Run Text="清理并压缩数据库" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="仅会清理实时便笺记录、签到记录等无用的数据" />
                                    </TextBlock>
                                    <Button HorizontalAlignment="Right"
                                            Command="{x:Bind vm.CompressDatabaseCommand, Mode=OneTime}"
                                            Content="开始清理" />
                                </Grid>
                                <Grid Padding="44,12,0,12">
                                    <TextBlock TextWrapping="Wrap">
                                        <Run Text="更新数据库表结构" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="开发过程中使用" />
                                    </TextBlock>
                                    <Button HorizontalAlignment="Right"
                                            Command="{x:Bind vm.MigrateDatabaseCommand, Mode=OneTime}"
                                            Content="开始更新" />
                                </Grid>
                            </StackPanel>
                        </Expander.Content>
                    </Expander>

                    <!--  图片缓存  -->
                    <Expander HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                        <Expander.Header>
                            <Grid>
                                <StackPanel Padding="4,16,0,16" Orientation="Horizontal">
                                    <TextBlock VerticalAlignment="Center"
                                               FontFamily="{ThemeResource SymbolThemeFontFamily}"
                                               FontSize="20"
                                               Text="&#xE81E;" />
                                    <TextBlock Margin="20,0,0,0">
                                        <Run Text="图片缓存" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="这个功能很有用" />
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Expander.Header>
                        <Expander.Content>
                            <StackPanel Margin="0,-16,44,-16">
                                <Grid Padding="44,12,0,12">
                                    <TextBlock TextWrapping="Wrap">
                                        <Run Text="预缓存所需图片" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="请耐心等待，如遇到卡顿或进程占用，可以重启应用后再重新下载" />
                                    </TextBlock>
                                    <StackPanel HorizontalAlignment="Right"
                                                Orientation="Horizontal"
                                                Spacing="8">
                                        <ProgressBar Width="160"
                                                     Maximum="{x:Bind vm.PrecacheImage_TotalCount}"
                                                     Visibility="{x:Bind vm.PrecacheAllImagesCommand.IsRunning, Converter={StaticResource BoolToVisibilityConverter}}"
                                                     Value="{x:Bind vm.PrecacheImage_FinishCount}" />
                                        <TextBlock VerticalAlignment="Center" Visibility="{x:Bind vm.PrecacheAllImagesCommand.IsRunning, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <Run Text="{x:Bind vm.PrecacheImage_FinishCount}" />
                                            <Run Text="/" />
                                            <Run Text="{x:Bind vm.PrecacheImage_TotalCount}" />
                                        </TextBlock>
                                        <Button Command="{x:Bind vm.PrecacheAllImagesCommand, Mode=OneTime}" Content="开始下载" />
                                    </StackPanel>
                                </Grid>
                                <Grid Padding="44,12,0,12">
                                    <TextBlock>
                                        <Run Text="清理图片缓存" />
                                        <LineBreak />
                                        <Run FontSize="12"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             Text="默认30天后自动清理过期图片" />
                                    </TextBlock>
                                    <Button HorizontalAlignment="Right"
                                            Command="{x:Bind vm.ClearImageCacheCommand, Mode=OneTime}"
                                            Content="开始清理" />
                                </Grid>
                            </StackPanel>
                        </Expander.Content>
                    </Expander>



                    <!--  其他  -->
                    <TextBlock />
                    <TextBlock Style="{ThemeResource SubtitleTextBlockStyle}" Text="其他" />
                    <StackPanel Orientation="Horizontal" Spacing="16">
                        <Button Command="{x:Bind vm.GetSpiralAbyssInfoSummaryCommand, Mode=OneTime}" Content="获取深渊记录" />
                        <controls:GenshinElementLoading Height="24"
                                                        IsActive="{x:Bind vm.GetSpiralAbyssInfoSummaryCommand.IsRunning}"
                                                        SyncActiveAndVisibility="True" />
                    </StackPanel>
                    <Button Command="{x:Bind vm.StartMapToolCommand, Mode=OneTime}" Content="启动小地图" />

                </StackPanel>



            </Grid>


        </ScrollViewer>


        <!--  网页小工具编辑面板  -->
        <Grid Name="_Grid_EditWebToolItem"
              Grid.RowSpan="2"
              Grid.Column="2"
              Width="400"
              Padding="12,0,12,0"
              HorizontalAlignment="Right"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="1"
              CornerRadius="4,0,0,4"
              RowSpacing="12"
              Visibility="{x:Bind vm.SelectedWebToolItem, Converter={StaticResource ObjectToVisibilityConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            <AppBarButton Width="40"
                          HorizontalAlignment="Right"
                          VerticalAlignment="Top"
                          Command="{x:Bind vm.CloseEditWebToolGridCommand, Mode=OneTime}"
                          Icon="Clear"
                          LabelPosition="Collapsed" />
            <StackPanel Grid.Row="1" Spacing="12">
                <TextBlock Style="{ThemeResource SubtitleTextBlockStyle}" Text="基础设置" />
                <TextBlock Text="标题" />
                <TextBox IsSpellCheckEnabled="False"
                         PlaceholderText="不要太长"
                         Text="{x:Bind vm.SelectedWebToolItem.Title, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                <TextBlock Text="图标" />
                <TextBox IsSpellCheckEnabled="False"
                         PlaceholderText="图标的网址"
                         Text="{x:Bind vm.SelectedWebToolItem.Icon, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                <TextBlock Text="网址" />
                <TextBox IsSpellCheckEnabled="False"
                         PlaceholderText="优先填这个，然后点下面的按键"
                         Text="{x:Bind vm.SelectedWebToolItem.Url, Mode=TwoWay}" />
                <Button Command="{x:Bind vm.GetTitleAndIconByUrlCommand}" Content="获取标题和图标" />
                <TextBlock Style="{ThemeResource SubtitleTextBlockStyle}" Text="高级设置" />
                <TextBlock Text="JavaScript" />
                <TextBox MaxHeight="300"
                         AcceptsReturn="True"
                         IsSpellCheckEnabled="False"
                         PlaceholderText="网页加载完成时会运行此脚本"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         Text="{x:Bind vm.SelectedWebToolItem.JavaScript, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         TextWrapping="Wrap" />
            </StackPanel>


        </Grid>


    </Grid>
</Page>
